version: '3.8'

# ============================================
# Docker Compose for Storefronts + Reverse Proxy
# ============================================
# This compose file adds the reverse proxy and storefront services
# to the existing Entrepreneur-OS infrastructure.
#
# Usage:
#   docker-compose -f docker-compose.yml -f docker-compose.storefronts.yml up -d
#
# This file extends the base docker-compose.yml and reuses the
# entrepreneur-network network for all services.
# ============================================

services:
  # ==========================================
  # REVERSE PROXY (Nginx)
  # ==========================================
  reverse-proxy:
    image: nginx:alpine
    container_name: entrepreneur-reverse-proxy
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./infrastructure/nginx/reverse-proxy.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - entrepreneur-network
    depends_on:
      - front-master
      - front-shop-01
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================================
  # STOREFRONT: Front Master (PIM/Catalog)
  # ==========================================
  front-master:
    build:
      context: .
      dockerfile: apps/storefront-vite/front-master/Dockerfile
    container_name: entrepreneur-front-master
    restart: unless-stopped
    networks:
      - entrepreneur-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    # Note: No ports exposed to host - accessed via reverse proxy

  # ==========================================
  # STOREFRONT: Front Shop 01 (E-commerce)
  # ==========================================
  front-shop-01:
    build:
      context: .
      dockerfile: apps/storefront-vite/front-shop-01/Dockerfile
    container_name: entrepreneur-front-shop-01
    restart: unless-stopped
    networks:
      - entrepreneur-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    # Note: No ports exposed to host - accessed via reverse proxy

# ============================================
# NETWORKS
# ============================================
# Reuse the existing entrepreneur-network from docker-compose.yml
networks:
  entrepreneur-network:
    external: true
